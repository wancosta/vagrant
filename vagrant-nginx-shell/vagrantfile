# Vagrantfile para VM Ubuntu 20.04 com rede em modo bridge
Vagrant.configure("2") do |config|
  
    # Definir a box do Ubuntu 20.04
    config.vm.box = "ubuntu/focal64"
    
    # Definir o nome da VM
    config.vm.hostname = "vagrant-nginx"
    
    # Configuração de rede em modo bridge
    config.vm.network "public_network", bridge: "TP-Link Wireless MU-MIMO USB Adapter" # Substitua pelo nome correto da interface no seu sistema
    
    # Esta configuração faz o redirecionamento da porta 8080 para a 80.
    config.vm.network "forwarded_port", guest: 80, host: 8080

    # Definir a quantidade de memória RAM (opcional)
    config.vm.provider "virtualbox" do |vb|
      vb.memory = "1024"
      vb.cpus = 1
    end
    
    # Sincronizar uma pasta do host com a VM
    # O primeiro argumento é o caminho no host, e o segundo é o caminho na VM
    config.vm.synced_folder "./pasta_local", "/vagrant/pasta_remota", create: true

    # Provisionar a VM com um script shell
    config.vm.provision "shell", inline: <<-SHELL
        # Atualizando o Ubuntu
        sudo apt-get update -y && sudo apt-get upgrade -y

        # Instalando o Nginx
        sudo apt-get install -y nginx
        
        # Criando diretório para o site ViaCEP
        sudo mkdir -p /var/www/html/viacep  

        # Baixando o exemplo do ViaCEP (conteúdo HTML e scripts)
        sudo wget https://viacep.com.br/exemplo/jquery/ -O /var/www/html/viacep/index.html
 
        # Criando um arquivo de configuração do Nginx para o site ViaCEP
        cat <<EOL | sudo tee /etc/nginx/sites-available/viacep
server {
    listen 80;
    server_name localhost;

    root /var/www/html/viacep;
    index index.html;

    location / {
        try_files \$uri \$uri/ =404;
    }
}
EOL

        # Ativando o site ViaCEP no Nginx
        sudo ln -s /etc/nginx/sites-available/viacep /etc/nginx/sites-enabled/

        # Desabilitando a configuração padrão do Nginx
        sudo rm /etc/nginx/sites-enabled/default

        # Substituindo o arquivo padrão do Nginx por um arquivo HTML customizado
        # sudo cp /vagrant/pasta_remota/index.html /var/www/html/index.nginx-debian.html

        # Reiniciando o Nginx para aplicar a mudança
        sudo systemctl restart nginx
    SHELL

  end